# v0.8.5 Integration & Testing Plan

**Date**: 2025-11-02
**Goal**: Single unified binary with PT02 progressive disclosure integrated
**Status**: PLANNING

---

## Current State Assessment

### Binaries (as of v0.8.4)
- ✅ `parseltongue` (26M) - Main unified binary with 6 subcommands
- ✅ `pt02-level00` (5.3M) - Standalone PT02 Level 0 binary
- ✅ `pt02-level01` (5.3M) - Standalone PT02 Level 1 binary
- ✅ `pt02-level02` (5.3M) - Standalone PT02 Level 2 binary

### Problem
- Main binary has OLD `pt02-llm-cozodb-to-context-writer` subcommand (uses --filter flag)
- NEW PT02 design (3 levels with progressive disclosure) exists as SEPARATE binaries
- User wants "a single binary" for v0.8.5

---

## Integration Strategy

### Option A: Replace OLD pt02 with 3 NEW subcommands (CHOSEN)

**Changes**:
1. Remove `pt02-llm-cozodb-to-context-writer` subcommand from main binary
2. Add 3 new subcommands:
   - `pt02-level00` - Pure edge list
   - `pt02-level01` - Entity + ISG + Temporal
   - `pt02-level02` - + Type system
3. Implement runner functions that delegate to pt02 library exports

**Pros**:
- Single binary with all functionality
- Follows progressive disclosure design from v0.8.4 docs
- Consistent with documentation already written

**Cons**:
- Need to implement CozoDB integration (currently TODO in binaries)
- More work upfront

---

## Implementation Plan (Step-by-Step)

### Phase 1: Code Changes

#### 1.1 Update main binary (crates/parseltongue/src/main.rs)

**Remove**:
- `pt02-llm-cozodb-to-context-writer` subcommand definition
- `run_llm_cozodb_to_context_writer()` function

**Add**:
- `pt02-level00` subcommand with `--where-clause` (required) and `--output` (optional)
- `pt02-level01` subcommand with `--include-code`, `--where-clause` (both required) and `--output`
- `pt02-level02` subcommand with same flags as level01
- Runner functions:
  ```rust
  async fn run_pt02_level00(matches: &ArgMatches) -> Result<()>
  async fn run_pt02_level01(matches: &ArgMatches) -> Result<()>
  async fn run_pt02_level02(matches: &ArgMatches) -> Result<()>
  ```

**Implementation approach**:
- For now: Print message that CozoDB integration is pending (pragmatic for v0.8.5)
- For v0.9.0: Full integration with parseltongue-core CozoDbStorage

---

### Phase 2: Comprehensive Testing on Parseltongue Repo

**Test Database**: `test-v085.db`

#### 2.1 Test pt01 (Index)
```bash
parseltongue pt01-folder-to-cozodb-streamer ./crates \
  --db rocksdb:test-v085.db \
  --verbose
```
**Expected**:
- Process ~63 Rust files
- Create ~661 entities
- Perform in <1 second

#### 2.2 Test pt02-level00 (Edge List)
```bash
parseltongue pt02-level00 \
  --where-clause "ALL" \
  --output edges-v085.json \
  --db rocksdb:test-v085.db \
  --verbose
```
**Expected**:
- Export dependency edges
- Token estimate shown
- JSON file created

#### 2.3 Test pt02-level01 (Signatures Only)
```bash
parseltongue pt02-level01 \
  --include-code 0 \
  --where-clause "ALL" \
  --output entities-sig-v085.json \
  --db rocksdb:test-v085.db \
  --verbose
```
**Expected**:
- Export all entities with signatures
- ~30K tokens estimate
- 14 fields per entity

#### 2.4 Test pt02-level01 (With Code)
```bash
parseltongue pt02-level01 \
  --include-code 1 \
  --where-clause "entity_name ~ 'test'" \
  --output entities-code-v085.json \
  --db rocksdb:test-v085.db
```
**Expected**:
- Export test entities with code
- Much larger file size
- current_code field populated

#### 2.5 Test pt02-level02 (Type System)
```bash
parseltongue pt02-level02 \
  --include-code 0 \
  --where-clause "is_public = true" \
  --output public-api-v085.json \
  --db rocksdb:test-v085.db
```
**Expected**:
- Export public entities with type info
- 22 fields per entity
- is_public, is_async, is_unsafe flags present

---

### Phase 3: Documentation Updates (Shreyas Doshi Style)

**Product Thinking Principles**:
1. **User Journey First**: What does the user want to accomplish?
2. **Progressive Disclosure**: Show simple commands first, advanced later
3. **Minimize Cognitive Load**: Clear examples, not exhaustive reference
4. **Context-Specific Help**: Right information at the right time

#### 3.1 README.md Updates

**Structure**:
```markdown
# Parseltongue

## What It Does
[One sentence value prop]

## Quick Start
[3 commands to get started - 80% use case]

## The 6 Tools
[Brief list with one-line descriptions]

## Command Reference
[Grouped by use case, not alphabetically]

### Reading Code (PT02)
[Progressive disclosure: Level 0 → Level 1 → Level 2]

## Examples
[Real use cases, not toy examples]
```

#### 3.2 PRDv2.md Updates

- Update PT02 section to reflect integrated commands
- Maintain consistency with README
- Add token cost examples

#### 3.3 PT02PRDv1.md Updates

- Document v0.8.5 integration status
- Keep detailed scope section
- Add testing results

#### 3.4 Parseltonge-SOP.md Updates

**New Patterns**:
```bash
# Pattern A: Quick Dependency Check (Level 0)
parseltongue pt02-level00 --where-clause "ALL" --output edges.json

# Pattern B: API Surface Review (Level 1, signatures only)
parseltongue pt02-level01 --include-code 0 \
  --where-clause "is_public = true" --output api.json

# Pattern C: Type Safety Audit (Level 2)
parseltongue pt02-level02 --include-code 0 \
  --where-clause "is_unsafe = true" --output unsafe.json
```

---

### Phase 4: Build & Release

#### 4.1 Build Release Binary
```bash
cargo build --release
strip target/release/parseltongue  # Reduce size
```

#### 4.2 Verify Single Binary
```bash
./target/release/parseltongue --help
./target/release/parseltongue pt02-level00 --help
./target/release/parseltongue pt02-level01 --help
./target/release/parseltongue pt02-level02 --help
```

#### 4.3 End-to-End Test
- Run full pipeline on parseltongue repo
- Document results in demo-walkthroughs/v0.8.5-testing/

#### 4.4 Commit & Push
```bash
git add -A
git commit -m "release: v0.8.5 - Single binary with PT02 progressive disclosure integrated"
git push origin main
```

---

## Success Criteria

- ✅ Single `parseltongue` binary with all 9 subcommands:
  - pt01-folder-to-cozodb-streamer
  - pt02-level00
  - pt02-level01
  - pt02-level02
  - pt03-llm-to-cozodb-writer
  - pt04-syntax-preflight-validator
  - pt05-llm-cozodb-to-diff-writer
  - pt06-cozodb-make-future-code-current
- ✅ All commands tested on parseltongue repo itself
- ✅ Documentation updated and consistent
- ✅ Binary size reasonable (<30MB)
- ✅ Help text clear and accurate

---

## Timeline

- **Phase 1 (Code)**: 30-45 minutes
- **Phase 2 (Testing)**: 45-60 minutes
- **Phase 3 (Docs)**: 60-90 minutes
- **Phase 4 (Release)**: 15-30 minutes

**Total**: 2.5-4 hours

---

**Next Step**: Implement Phase 1 code changes
