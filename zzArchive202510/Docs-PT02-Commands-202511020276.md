# Parseltongue Complete Commands Reference

**Version**: v0.8.3
**Date**: 2025-11-02
**Scope**: All 6 tools (PT01-PT06)
**Status**: ALL IMPLEMENTED ✅

---

## Section 1: Command Summary (Concise List)

| Tool | Binary | Required Args | Status |
|------|--------|---------------|--------|
| **PT01** | `pt01-folder-to-cozodb-streamer` | `<directory>` | ✅ |
| **PT02** | `pt02-llm-cozodb-to-context-writer` | `--output`, (`--include-current-code` OR `--query`) | ✅ |
| **PT03** | `pt03-llm-to-cozodb-writer` | (`--entity` + `--action`) OR `--query` | ✅ |
| **PT04** | `pt04-syntax-preflight-validator` | (none) | ✅ |
| **PT05** | `pt05-llm-cozodb-to-diff-writer` | (none) | ✅ |
| **PT06** | `pt06-cozodb-make-future-code-current` | `--database`, `--project-path` | ✅ |

---

## Section 2: Detailed Arguments Reference

### PT01: folder-to-cozodb-streamer

**Binary**: `pt01-folder-to-cozodb-streamer`
**Source**: `crates/pt01-folder-to-cozodb-streamer/src/cli.rs:14-53`
**Version**: 0.7.1

**Required Arguments**:
- `<directory>` (positional) - Directory to index

**Optional Arguments**:
- `--db PATH` (default: `"mem"`) - Database connection string
- `-v, --verbose` - Enable verbose output
- `-q, --quiet` - Suppress output except errors

**Argument Conflicts**:
- `--verbose` conflicts with `--quiet`

**Hardcoded Internals** (not CLI-exposed):
- max_file_size: 100MB
- include_patterns: `["*"]`
- exclude_patterns: `["target", "node_modules", ".git", "build", "dist", "__pycache__", ".venv", "venv"]`
- parsing_library: `"tree-sitter"`
- chunking: `"ISGL1"`

---

### PT02: llm-cozodb-to-context-writer

**Binary**: `pt02-llm-cozodb-to-context-writer`
**Source**: `crates/pt02-llm-cozodb-to-context-writer/src/cli.rs:30-106`
**Version**: 0.8.2

**Dual Interface Design**:

#### Mode 1: Simple (Composed Query)
**Required**:
- `--output PATH` or `-o PATH` - Output JSON file path
- `--include-current-code {0|1}` - Include code field (0=signatures, 1=with code)

**Optional**:
- `--db PATH` (default: `"parseltongue.db"`) - Database file path
- `--where FILTER` (default: `"ALL"`) - Datalog WHERE clause

#### Mode 2: Advanced (Raw Datalog)
**Required**:
- `--output PATH` or `-o PATH` - Output JSON file path
- `--query DATALOG` - Full Datalog query

**Optional**:
- `--db PATH` (default: `"parseltongue.db"`) - Database file path

**Argument Conflicts**:
- `--query` conflicts with `--include-current-code` and `--where`
- Mutual exclusion: Exactly one of `--query` or `--include-current-code` required (cli.rs:100-105)

**Token Optimization**:
- `--include-current-code 0`: ~5K tokens (signatures only)
- `--include-current-code 1`: ~500K tokens (with code) - 100x more expensive

---

### PT03: llm-to-cozodb-writer

**Binary**: `pt03-llm-to-cozodb-writer`
**Source**: `crates/pt03-llm-to-cozodb-writer/src/cli.rs:17-91`
**Version**: 0.7.1

**Dual Interface Design**:

#### Mode 1: Simple (Entity Operations)
**Required**:
- `--entity ISGL1_KEY` - ISGL1 entity key to modify
- `--action {create|edit|delete}` - Temporal action (validated enum)

**Optional**:
- `--future-code CODE` - Future code content (required for create/edit)
- `--db PATH` (default: `"parseltongue.db"`) - Database file path

#### Mode 2: Advanced (Raw Datalog)
**Required**:
- `--query DATALOG` - Raw Datalog query to execute

**Optional**:
- `--db PATH` (default: `"parseltongue.db"`) - Database file path

**Argument Conflicts**:
- `--query` conflicts with `--entity`, `--action`, `--future-code`
- Mutual exclusion: Exactly one of `--query` or `--entity` required (cli.rs:76-80)

**Temporal State Mappings**:
- `create`: (current_ind=0, future_ind=1, Future_Action="Create")
- `edit`: (current_ind=1, future_ind=1, Future_Action="Edit")
- `delete`: (current_ind=1, future_ind=0, Future_Action="Delete")

---

### PT04: syntax-preflight-validator

**Binary**: `pt04-syntax-preflight-validator`
**Source**: `crates/pt04-syntax-preflight-validator/src/main.rs:13-30`

**Optional Arguments**:
- `--database STRING` (default: `"mem"`) - Path to CozoDB database
- `-v, --verbose` - Verbose output

**No Required Arguments** (queries database directly for entities with future_code)

**Validation Scope**:
- ✅ Syntax errors (tree-sitter parsing)
- ❌ Type errors (cargo handles)
- ❌ Import resolution (cargo handles)
- ❌ Lifetime issues (cargo handles)

**Performance**: <20ms for typical change set (50 entities)

**Note**: CLI args in `cli.rs:14-58` are deprecated (--code-snippet, --file, --validation-type, --output-format). Current implementation uses database-direct approach.

---

### PT05: llm-cozodb-to-diff-writer

**Binary**: `pt05-llm-cozodb-to-diff-writer`
**Source**: `crates/pt05-llm-cozodb-to-diff-writer/src/main.rs:14-30`

**Optional Arguments**:
- `--database STRING` (default: `"./parseltongue.db"`) - Path to CozoDB database
- `--output PATH` (default: `"./CodeDiff.json"`) - Output path for CodeDiff.json
- `-v, --verbose` - Verbose output

**No Required Arguments** (sensible defaults for standard workflow)

**What It Generates**:
- CodeDiff.json with entities where Future_Action != None
- Structure: ISGL1 key, file path, operation, future code, interface signature

**What It Does NOT Do**:
- Does NOT write files (LLM handles)
- Does NOT create backups
- Does NOT validate code

---

### PT06: cozodb-make-future-code-current

**Binary**: `pt06-cozodb-make-future-code-current`
**Source**: `crates/pt06-cozodb-make-future-code-current/src/cli.rs:15-44`

**Required Arguments**:
- `--database STRING` - CozoDB connection string (e.g., "rocksdb:parseltongue.db")
- `--project-path PATH` - Project root directory for re-indexing

**Optional Arguments**:
- `-v, --verbose` - Enable verbose output
- `--reindex` (default: `true`) - Automatically re-index after reset

**Operation**:
1. Deletes CodeGraph table
2. Recreates schema
3. Calls PT01 as subprocess (if --reindex=true)

**Ultra-Minimalist Principles**:
- NO BACKUP METADATA
- NO ROLLBACK
- NO CONFIGURATION
- Direct table deletion → recreate → re-index

---

## Argument Type Reference

### Common Patterns

| Pattern | Type | Tools Using |
|---------|------|-------------|
| `--db PATH` | String | PT01, PT02, PT03 |
| `--database STRING` | String | PT04, PT05, PT06 |
| `-v, --verbose` | Flag | PT01, PT04, PT05, PT06 |
| `-q, --quiet` | Flag | PT01 |
| `--output PATH` | String (required) | PT02, PT05 |

### Mutual Exclusion Groups

| Tool | Group Name | Arguments | Rule |
|------|------------|-----------|------|
| PT01 | verbosity | `--verbose`, `--quiet` | Cannot use both |
| PT02 | interface_mode | `--query`, `--include-current-code` | Must use exactly one |
| PT03 | interface_mode | `--query`, `--entity` | Must use exactly one |

### Validated Enums

| Tool | Argument | Valid Values | Validation Location |
|------|----------|--------------|---------------------|
| PT02 | `--include-current-code` | `0`, `1` | cli.rs:80 |
| PT03 | `--action` | `create`, `edit`, `delete` | cli.rs:48 (value_parser) |

---

## Implementation Status Summary

| Tool | CLI Status | Implementation | LOC | Files |
|------|------------|----------------|-----|-------|
| PT01 | ✅ Complete | ✅ Fully implemented | ~800 | cli.rs, main.rs, lib.rs, streamer.rs, isgl1_generator.rs |
| PT02 | ✅ Complete | ✅ Fully implemented | ~750 | cli.rs, main.rs, lib.rs, query_builder.rs |
| PT03 | ✅ Complete | ✅ Fully implemented | ~650 | cli.rs, main.rs, lib.rs |
| PT04 | ✅ Simplified | ✅ MVP implemented | ~400 | main.rs, lib.rs |
| PT05 | ✅ Complete | ✅ Fully implemented | ~300 | main.rs, lib.rs |
| PT06 | ✅ Complete | ✅ Fully implemented | ~500 | cli.rs, main.rs, lib.rs |

**Total Implementation**: ~3,400 LOC across 6 tools

---

## Tool Workflow Sequence

```
PT01: Index codebase → CodeGraph (current_ind=1, future_ind=0)
  ↓
PT02: Export context → JSON (for LLM consumption)
  ↓
[LLM analyzes and plans changes externally]
  ↓
PT03: Write changes → CodeGraph (set future_code + temporal state)
  ↓
PT04: Validate syntax → Check future_code parses correctly
  ↓
PT05: Generate diff → CodeDiff.json (for LLM to apply)
  ↓
[LLM applies changes to filesystem]
  ↓
PT06: Reset state → Make future_code current, re-index
```

---

## Architecture Principles (S01)

All tools follow these design principles:

1. **Ultra-Minimalist**: Minimal arguments, sensible defaults, no unused flags
2. **Progressive Disclosure**: Simple mode (80%) + Advanced mode (20%) where applicable
3. **Executable Specifications**: Command names self-document purpose
4. **TDD-First**: Comprehensive test coverage
5. **Token Optimization** (PT02): Explicit cost control
6. **Temporal State Model** (PT03): Create/Edit/Delete → temporal indicators
7. **NO Config Files**: All configuration via CLI arguments
8. **NO Side Effects**: Pure operations (except PT06 reset)

---

## Documented vs Implemented Gap

**PT02 Documentation** (lib.rs:107-124):
Lists 10 "core operations" but only 1 is exposed in PT02 CLI.

### Implementation Status: 6/10 Fully Built, 4 Hidden

#### ✅ FULLY IMPLEMENTED (6 operations)

**Exposed in PT02 Binary** (1 operation):
1. **export-all-entities-json** - `pt02-llm-cozodb-to-context-writer` with dual interface

**Hidden in Core Library** (5 operations - PRODUCTION READY):
2. **query-blast-radius-hops{N}** - `parseltongue-core::storage::cozo_client::calculate_blast_radius()`
   - Location: `crates/parseltongue-core/src/storage/cozo_client.rs:305-372`
   - Tests: 4 comprehensive tests
   - Performance: <50ms for 5 hops on 10k nodes

3. **query-forward-deps-json** - `get_forward_dependencies(isgl1_key)`
   - Location: `crates/parseltongue-core/src/storage/cozo_client.rs:420-443`
   - Tests: 5 tests including performance validation

4. **query-reverse-deps-json** - `get_reverse_dependencies(isgl1_key)`
   - Location: `crates/parseltongue-core/src/storage/cozo_client.rs:491-514`
   - Tests: 4 tests

5. **query-transitive-closure-json** - `get_transitive_closure(isgl1_key)`
   - Location: `crates/parseltongue-core/src/storage/cozo_client.rs:588-625`
   - Tests: 4 tests including cycle handling

7. **get-entity-by-key** - `get_entity(isgl1_key)` via `CodeGraphRepository` trait
   - Location: `crates/parseltongue-core/src/storage/cozo_client.rs:692-722`

#### ⚠️ PARTIALLY IMPLEMENTED (2 operations)

8. **introspect-db-schema-json** - `list_relations()` (relation names only, no column schemas)
   - Location: `crates/parseltongue-core/src/storage/cozo_client.rs:642-659`

10. **compare-current-future-diff** - Query implemented (`get_changed_entities()`), export in PT05 not PT02
   - Query: `crates/parseltongue-core/src/storage/cozo_client.rs:772-799`
   - Export: `crates/pt05-llm-cozodb-to-diff-writer/`

#### ❌ NOT IMPLEMENTED (2 operations)

6. **query-bidirectional-deps-json** - Can be synthesized by combining ops 3+4
9. **analyze-entity-count-json** - No statistics API (use `get_all_entities().len()` workaround)

### Critical Finding

**Operations 2-5 (dependency graph queries) are FULLY IMPLEMENTED and TESTED but completely hidden from PT02 CLI.**

**Gap**: PT02 only exposes CodeGraph exports (operation #1). Dependency graph operations (ops 2-5) are production-ready in `parseltongue-core` but have NO CLI interface.

**Opportunity**: Expose these 4 hidden operations via new PT02 flag (e.g., `--export-dependencies`) for 8-13x token savings vs current ISG exports.

---

## Quick Reference: Minimal Command Invocations

```bash
# PT01: Index current directory with in-memory database
pt01-folder-to-cozodb-streamer .

# PT02: Export all entities, signatures only (cheapest)
pt02-llm-cozodb-to-context-writer -o ctx.json --include-current-code 0

# PT03: Edit an entity
pt03-llm-to-cozodb-writer --entity "KEY" --action edit --future-code "CODE"

# PT04: Validate syntax of all future_code
pt04-syntax-preflight-validator

# PT05: Generate diff for LLM
pt05-llm-cozodb-to-diff-writer

# PT06: Reset and re-index
pt06-cozodb-make-future-code-current --database rocksdb:db.db --project-path .
```

---

**End of Parseltongue Complete Commands Reference**
