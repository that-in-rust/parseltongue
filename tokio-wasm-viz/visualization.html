<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rust Code Structure Visualization</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.21.0/cytoscape.min.js"></script>
  <script src="https://unpkg.com/layout-base/layout-base.js"></script>
  <script src="https://unpkg.com/cose-base/cose-base.js"></script>
  <script src="https://unpkg.com/cytoscape-fcose/cytoscape-fcose.js"></script>
  <script src="https://unpkg.com/cytoscape-context-menus/cytoscape-context-menus.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/cytoscape-context-menus/cytoscape-context-menus.css">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      overflow: hidden;
    }
    
    #cy {
      width: 100%;
      height: 100vh;
      position: absolute;
      left: 0;
      top: 0;
      z-index: 1;
      background-color: #f8f9fa;
    }
    
    #loading-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 100;
      text-align: center;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 4px solid #3498db;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    #controls {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 10;
      background: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      width: 280px;
    }
    
    #controls h3 {
      margin-bottom: 15px;
      color: #333;
      border-bottom: 1px solid #eee;
      padding-bottom: 8px;
    }
    
    .control-group {
      margin-bottom: 15px;
    }
    
    .control-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #555;
    }
    
    .control-group input, .control-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .btn {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 8px;
      margin-bottom: 8px;
      transition: background-color 0.2s;
    }
    
    .btn:hover {
      background-color: #2980b9;
    }
    
    .btn-secondary {
      background-color: #95a5a6;
    }
    
    .btn-secondary:hover {
      background-color: #7f8c8d;
    }
    
    #info-panel {
      position: absolute;
      bottom: 20px;
      left: 20px;
      z-index: 10;
      background: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      max-width: 350px;
      display: none;
    }
    
    #info-panel h3 {
      margin-bottom: 10px;
      color: #333;
      border-bottom: 1px solid #eee;
      padding-bottom: 8px;
    }
    
    #info-content p {
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    #info-content strong {
      color: #2c3e50;
    }
    
    #stats-panel {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 10;
      background: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      width: 200px;
    }
    
    #stats-panel h3 {
      margin-bottom: 10px;
      color: #333;
      border-bottom: 1px solid #eee;
      padding-bottom: 8px;
    }
    
    .stat-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-size: 14px;
    }
    
    .stat-label {
      color: #555;
    }
    
    .stat-value {
      font-weight: bold;
      color: #2c3e50;
    }
    
    .legend {
      margin-top: 15px;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
      font-size: 13px;
    }
    
    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 3px;
      margin-right: 8px;
      border: 1px solid #333;
    }
    
    .notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #2ecc71;
      color: white;
      padding: 12px 20px;
      border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .notification.error {
      background: #e74c3c;
    }
    
    .notification.show {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div id="loading-indicator">
    <div class="spinner"></div>
    <p>Loading graph data...</p>
  </div>
  
  <div id="cy"></div>
  
  <div id="stats-panel">
    <h3>Graph Statistics</h3>
    <div class="stat-item">
      <span class="stat-label">Total Nodes:</span>
      <span class="stat-value" id="total-nodes">0</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Total Edges:</span>
      <span class="stat-value" id="total-edges">0</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Visible Nodes:</span>
      <span class="stat-value" id="visible-nodes">0</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Visible Edges:</span>
      <span class="stat-value" id="visible-edges">0</span>
    </div>
    
    <div class="legend">
      <h4 style="margin-bottom: 8px; font-size: 14px;">Node Types</h4>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #6FB1FC;"></div>
        <span>Struct</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #F5A45D;"></div>
        <span>Trait</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #8DCC93;"></div>
        <span>Function</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #D8BFD8;"></div>
        <span>Enum</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #FFA07A;"></div>
        <span>Module</span>
      </div>
    </div>
  </div>
  
  <div id="controls">
    <h3>Controls</h3>
    
    <div class="control-group">
      <label for="layout-select">Layout:</label>
      <select id="layout-select">
        <option value="fcose">Force-Directed</option>
        <option value="circle">Circle</option>
        <option value="grid">Grid</option>
        <option value="breadthfirst">Hierarchical</option>
        <option value="concentric">Concentric</option>
      </select>
    </div>
    
    <div class="control-group">
      <label for="search-input">Search Nodes:</label>
      <input type="text" id="search-input" placeholder="Node name...">
    </div>
    
    <div class="control-group">
      <label>Filter by Type:</label>
      <div>
        <label style="font-weight: normal; display: inline-block; margin-right: 10px;">
          <input type="checkbox" class="type-filter" value="Struct" checked> Struct
        </label>
        <label style="font-weight: normal; display: inline-block; margin-right: 10px;">
          <input type="checkbox" class="type-filter" value="Trait" checked> Trait
        </label>
        <label style="font-weight: normal; display: inline-block; margin-right: 10px;">
          <input type="checkbox" class="type-filter" value="Function" checked> Function
        </label>
        <label style="font-weight: normal; display: inline-block; margin-right: 10px;">
          <input type="checkbox" class="type-filter" value="Enum" checked> Enum
        </label>
        <label style="font-weight: normal; display: inline-block;">
          <input type="checkbox" class="type-filter" value="Module" checked> Module
        </label>
      </div>
    </div>
    
    <div class="control-group">
      <button id="reset-btn" class="btn btn-secondary">Reset View</button>
      <button id="export-btn" class="btn">Export</button>
    </div>
  </div>
  
  <div id="info-panel">
    <h3>Node Information</h3>
    <div id="info-content"></div>
  </div>
  
  <div id="notification" class="notification"></div>

  <script>
    // Initialize Cytoscape
    let cy;
    
    // Function to transform JSON data to Cytoscape format
    function transformData(jsonData) {
      const elements = {
        nodes: [],
        edges: []
      };
      
      // Transform nodes
      jsonData.nodes.forEach(node => {
        elements.nodes.push({
          data: {
            id: node.hash.toString(),
            label: node.name,
            kind: node.kind,
            signature: node.signature,
            file_path: node.file_path,
            line: node.line
          }
        });
      });
      
      // Transform edges
      jsonData.edges.forEach(edge => {
        elements.edges.push({
          data: {
            source: edge[0].toString(),
            target: edge[1].toString(),
            relationship: edge[2]
          }
        });
      });
      
      return elements;
    }
    
    // Function to show notification
    function showNotification(message, isError = false) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = 'notification show';
      if (isError) {
        notification.classList.add('error');
      }
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }
    
    // Function to update statistics
    function updateStats() {
      document.getElementById('total-nodes').textContent = cy.nodes().length;
      document.getElementById('total-edges').textContent = cy.edges().length;
      document.getElementById('visible-nodes').textContent = cy.nodes(':visible').length;
      document.getElementById('visible-edges').textContent = cy.edges(':visible').length;
    }
    
    // Function to show node information
    function showNodeInfo(node) {
      const panel = document.getElementById('info-panel');
      const content = document.getElementById('info-content');
      
      content.innerHTML = `
        <p><strong>Name:</strong> ${node.data('label')}</p>
        <p><strong>Kind:</strong> ${node.data('kind')}</p>
        <p><strong>Signature:</strong> ${node.data('signature')}</p>
        <p><strong>File:</strong> ${node.data('file_path')}</p>
        <p><strong>Line:</strong> ${node.data('line')}</p>
        <p><strong>Connections:</strong> ${node.connectedEdges().length}</p>
      `;
      
      panel.style.display = 'block';
    }
    
    // Function to initialize the graph
    async function initializeGraph() {
      try {
        // Load data from JSON file
        const response = await fetch('isg_data.json');
        if (!response.ok) {
          throw new Error(`Failed to load data: ${response.status}`);
        }
        
        const jsonData = await response.json();
        
        // Transform data for Cytoscape
        const elements = transformData(jsonData);
        
        // Initialize Cytoscape
        cy = cytoscape({
          container: document.getElementById('cy'),
          elements: elements,
          
          style: [
            {
              selector: 'node',
              style: {
                'background-color': function(ele) {
                  // Different colors based on node kind
                  const kind = ele.data('kind');
                  switch(kind) {
                    case 'Struct': return '#6FB1FC';
                    case 'Trait': return '#F5A45D';
                    case 'Function': return '#8DCC93';
                    case 'Enum': return '#D8BFD8';
                    case 'Module': return '#FFA07A';
                    default: return '#CCCCCC';
                  }
                },
                'label': 'data(label)',
                'text-valign': 'center',
                'text-halign': 'center',
                'width': 60,
                'height': 60,
                'font-size': '12px',
                'color': '#000',
                'border-width': 2,
                'border-color': '#333',
                'shape': function(ele) {
                  // Different shapes based on node kind
                  const kind = ele.data('kind');
                  switch(kind) {
                    case 'Struct': return 'rectangle';
                    case 'Trait': return 'diamond';
                    case 'Function': return 'round-rectangle';
                    case 'Enum': return 'hexagon';
                    case 'Module': return 'round-triangle';
                    default: return 'ellipse';
                  }
                },
                'text-wrap': 'wrap',
                'text-max-width': '80px'
              }
            },
            {
              selector: 'edge',
              style: {
                'width': 2,
                'line-color': '#999',
                'target-arrow-color': '#999',
                'target-arrow-shape': 'triangle',
                'curve-style': 'bezier',
                'label': 'data(relationship)',
                'font-size': '10px',
                'color': '#333'
              }
            },
            {
              selector: 'node:selected',
              style: {
                'background-color': '#FF6B6B',
                'border-width': 3,
                'border-color': '#E63946'
              }
            },
            {
              selector: 'edge:selected',
              style: {
                'line-color': '#E63946',
                'target-arrow-color': '#E63946',
                'width': 3
              }
            },
            {
              selector: '.highlighted',
              style: {
                'background-color': '#FFD166',
                'border-color': '#FCBF49',
                'border-width': 3
              }
            },
            {
              selector: '.dimmed',
              style: {
                'opacity': 0.3
              }
            }
          ],
          
          layout: {
            name: 'fcose',
            quality: 'default',
            randomize: false,
            animate: true,
            animationDuration: 1000,
            fit: true,
            padding: 50,
            nodeRepulsion: 4500,
            idealEdgeLength: 100,
            edgeElasticity: 0.45,
            nestingFactor: 0.1
          }
        });
        
        // Add context menu
        cy.contextMenus({
          menuItems: [
            {
              id: 'show-details',
              content: 'Show Details',
              tooltipText: 'Show more details about this node',
              selector: 'node',
              onClickFunction: function(event) {
                const node = event.target;
                showNodeInfo(node);
              }
            },
            {
              id: 'highlight-neighbors',
              content: 'Highlight Connected Nodes',
              tooltipText: 'Highlight all nodes connected to this one',
              selector: 'node',
              onClickFunction: function(event) {
                const node = event.target;
                const neighborhood = node.neighborhood();
                
                cy.elements().removeClass('highlighted');
                cy.elements().removeClass('dimmed');
                
                neighborhood.addClass('highlighted');
                cy.elements().difference(neighborhood.union(node)).addClass('dimmed');
              }
            },
            {
              id: 'reset-highlight',
              content: 'Reset Highlight',
              tooltipText: 'Remove all highlights',
              selector: 'node',
              onClickFunction: function() {
                cy.elements().removeClass('highlighted');
                cy.elements().removeClass('dimmed');
              }
            }
          ]
        });
        
        // Event handlers
        cy.on('tap', 'node', function(evt) {
          const node = evt.target;
          showNodeInfo(node);
        });
        
        cy.on('tap', function(evt) {
          if (evt.target === cy) {
            document.getElementById('info-panel').style.display = 'none';
            cy.elements().removeClass('highlighted');
            cy.elements().removeClass('dimmed');
          }
        });
        
        // Update statistics after layout
        cy.on('layoutstop', function() {
          updateStats();
        });
        
        // Setup control panel functionality
        setupControls();
        
        // Hide loading indicator
        document.getElementById('loading-indicator').style.display = 'none';
        
        // Show success notification
        showNotification(`Loaded ${jsonData.nodes.length} nodes and ${jsonData.edges.length} edges`);
        
      } catch (error) {
        console.error('Error initializing graph:', error);
        document.getElementById('loading-indicator').innerHTML = `
          <p style="color: #e74c3c;">Error loading data: ${error.message}</p>
          <button class="btn" onclick="location.reload()">Retry</button>
        `;
        showNotification(`Error: ${error.message}`, true);
      }
    }
    
    // Function to setup control panel
    function setupControls() {
      // Layout selector
      document.getElementById('layout-select').addEventListener('change', function(e) {
        const layoutName = e.target.value;
        cy.layout({
          name: layoutName,
          animate: true,
          animationDuration: 1000,
          fit: true
        }).run();
      });
      
      // Search functionality
      document.getElementById('search-input').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        
        if (searchTerm === '') {
          cy.elements().removeClass('highlighted');
          cy.elements().removeClass('dimmed');
          return;
        }
        
        cy.elements().removeClass('highlighted');
        cy.elements().removeClass('dimmed');
        
        const matchingNodes = cy.nodes().filter(node => {
          const name = node.data('label').toLowerCase();
          return name.includes(searchTerm);
        });
        
        if (matchingNodes.length > 0) {
          matchingNodes.addClass('highlighted');
          const connectedEdges = matchingNodes.connectedEdges();
          const connectedNodes = connectedEdges.connectedNodes();
          
          connectedNodes.addClass('highlighted');
          connectedEdges.addClass('highlighted');
          
          cy.elements().difference(
            matchingNodes.union(connectedNodes).union(connectedEdges)
          ).addClass('dimmed');
        }
      });
      
      // Type filters
      document.querySelectorAll('.type-filter').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const nodeType = this.value;
          const isChecked = this.checked;
          
          cy.nodes(`[kind = "${nodeType}"]`).forEach(node => {
            if (isChecked) {
              node.show();
            } else {
              node.hide();
            }
          });
          
          updateStats();
        });
      });
      
      // Reset view button
      document.getElementById('reset-btn').addEventListener('click', function() {
        cy.fit();
        cy.elements().removeClass('highlighted');
        cy.elements().removeClass('dimmed');
        document.getElementById('search-input').value = '';
      });
      
      // Export button
      document.getElementById('export-btn').addEventListener('click', function() {
        const png = cy.png({ scale: 2, full: true });
        const a = document.createElement('a');
        a.href = png;
        a.download = 'rust-code-structure.png';
        a.click();
        
        showNotification('Graph exported as PNG');
      });
    }
    
    // Initialize the graph when the page loads
    document.addEventListener('DOMContentLoaded', initializeGraph);
  </script>
</body>
</html>